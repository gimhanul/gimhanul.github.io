"use strict";(self.webpackChunkminimal_blog=self.webpackChunkminimal_blog||[]).push([[153],{4765:function(e,n,t){t.d(n,{F:function(){return m},Z:function(){return d}});var a=t(7294),i=t(8733),l=t(795),c=t(8377),r=t(6799),s=t(8871);var o=e=>{let{post:n}=e;return null};const g=["16px","8px","4px"].map((e=>"rgba(0, 0, 0, 0.1) 0px "+e+" "+e+" 0px"));var p=e=>{let{data:{post:n},children:t}=e;return(0,i.tZ)(c.Z,null,(0,i.tZ)(l.X6,{as:"h1",variant:"styles.h1"},n.title),(0,i.tZ)("p",{sx:{color:"secondary",mt:3,a:{color:"secondary"},fontSize:[1,1,2]}},(0,i.tZ)("time",null,n.date),n.tags&&(0,i.tZ)(a.Fragment,null," — ",(0,i.tZ)(r.Z,{tags:n.tags})),n.timeToRead&&" — ",n.timeToRead&&(0,i.tZ)("span",null,n.timeToRead," min read")),(0,i.tZ)("section",{sx:{my:5,".gatsby-resp-image-wrapper":{my:[4,4,5],borderRadius:"4px",boxShadow:g.join(", "),".gatsby-resp-image-image":{borderRadius:"4px"}},variant:"layout.content"}},t),(0,i.tZ)(o,{post:n}))};const m=e=>{var n,t,a;let{data:{post:l}}=e;return(0,i.tZ)(s.Z,{title:l.title,description:l.description?l.description:l.excerpt,image:l.banner?null===(n=l.banner)||void 0===n||null===(t=n.childImageSharp)||void 0===t||null===(a=t.resize)||void 0===a?void 0:a.src:void 0,pathname:l.slug,canonicalUrl:l.canonicalUrl})};function d(e){let{...n}=e;return a.createElement(p,n)}},6799:function(e,n,t){var a=t(8733),i=t(7294),l=t(1883),c=t(3494),r=t(9706);n.Z=e=>{let{tags:n}=e;const{tagsPath:t,basePath:s}=(0,c.Z)();return(0,a.tZ)(i.Fragment,null,n.map(((e,n)=>(0,a.tZ)(i.Fragment,{key:e.slug},!!n&&", ",(0,a.tZ)(l.Link,{sx:e=>{var n;return{...null===(n=e.styles)||void 0===n?void 0:n.a}},to:(0,r.Z)("/"+s+"/"+t+"/"+e.slug)},e.name)))))}},8871:function(e,n,t){var a=t(7294),i=t(1883),l=t(4232);n.Z=e=>{let{title:n="",description:t="",pathname:c="",image:r="",children:s=null,canonicalUrl:o=""}=e;const g=(0,l.Z)(),{siteTitle:p,siteTitleAlt:m,siteUrl:d,siteDescription:A,siteImage:b,author:u,siteLanguage:h}=g,E={title:n?n+" | "+p:m,description:t||A,url:""+d+(c||""),image:""+d+(r||b)};return a.createElement(a.Fragment,null,a.createElement("html",{lang:h}),a.createElement("title",null,E.title),a.createElement("meta",{name:"description",content:E.description}),a.createElement("meta",{name:"image",content:E.image}),a.createElement("meta",{property:"og:title",content:E.title}),a.createElement("meta",{property:"og:url",content:E.url}),a.createElement("meta",{property:"og:description",content:E.description}),a.createElement("meta",{property:"og:image",content:E.image}),a.createElement("meta",{property:"og:type",content:"website"}),a.createElement("meta",{property:"og:image:alt",content:E.description}),a.createElement("meta",{name:"twitter:card",content:"summary_large_image"}),a.createElement("meta",{name:"twitter:title",content:E.title}),a.createElement("meta",{name:"twitter:url",content:E.url}),a.createElement("meta",{name:"twitter:description",content:E.description}),a.createElement("meta",{name:"twitter:image",content:E.image}),a.createElement("meta",{name:"twitter:image:alt",content:E.description}),a.createElement("meta",{name:"twitter:creator",content:u}),a.createElement("meta",{name:"gatsby-theme",content:"@lekoarts/gatsby-theme-minimal-blog"}),a.createElement("link",{rel:"icon",type:"image/png",sizes:"32x32",href:(0,i.withPrefix)("/favicon-32x32.png")}),a.createElement("link",{rel:"icon",type:"image/png",sizes:"16x16",href:(0,i.withPrefix)("/favicon-16x16.png")}),a.createElement("link",{rel:"apple-touch-icon",sizes:"180x180",href:(0,i.withPrefix)("/apple-touch-icon.png")}),o?a.createElement("link",{rel:"canonical",href:o}):null,s)}},8388:function(e,n,t){t.r(n),t.d(n,{Head:function(){return r.F},default:function(){return s}});var a=t(7294),i=t(1151);function l(e){const n=Object.assign({h2:"h2",p:"p",span:"span",h3:"h3",h4:"h4",blockquote:"blockquote",strong:"strong",ul:"ul",li:"li"},(0,i.ah)(),e.components);return a.createElement(a.Fragment,null,a.createElement(n.h2,null,"문제 발생"),"\n",a.createElement(n.p,null,"한 페이지에서 5개의 api가 pending 상태로만 머물러 있고 응답이 오지 않는 현상이 발생했습니다."),"\n",a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 744px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 27.083333333333332%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA0ElEQVR42j2PgZLCIAxE+/8f6FlbrVVEvfGEJBQolPa2dsYZhiEb3mZTeSalbq8/M6YpTzNOyvPbcMqFZZjKclH60LSn7hxiJnbsvCUx5NCqohOt78byRn7g8jaExxeuD2177HxMgEmGDywrbC1p/Rh8KPOCGjcwS875IM5DuSrdtMdT1/uQQkyYLDLAIgNG4PvjCTPLshoTWsFYgsKywv1F7esGNOCYpg22vIaqkPCqbs/fF5LAGNnwAyLKzf7cq91PjbVdGMOYSTx07JzL8g8a0BtIw3BWvAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="fiveapis"\n        title=""\n        src="/static/b0b93fefbb5ae14c62829ff06c5b7ed8/f2f9b/fiveapis.png"\n        srcset="/static/b0b93fefbb5ae14c62829ff06c5b7ed8/5243c/fiveapis.png 240w,\n/static/b0b93fefbb5ae14c62829ff06c5b7ed8/ab158/fiveapis.png 480w,\n/static/b0b93fefbb5ae14c62829ff06c5b7ed8/f2f9b/fiveapis.png 744w"\n        sizes="(max-width: 744px) 100vw, 744px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}}),"\n",a.createElement("br"),"\n",a.createElement(n.h2,null,"삽질 엿보기"),"\n",a.createElement(n.h3,null,"가설1: Hikari Connection Pool Deadlock"),"\n",a.createElement(n.p,null,"가장 먼저 Hikari Connection Pool Deadlock 현상일 것이라고 가정하고 이를 확인했습니다.\nconnection pool의 상태를 로그로 남겨보았습니다.\n",a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 368px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 30.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCElEQVR42hWQDaqEMAyEvcc+jW1jm/6nrbqiLsLe/1CvC0MYwkC+yRBD3tZ3rWuray3t+TzXcUaf7vOOPpbEnOu+7sd+XOencu26zkuAGl8weBdT5Bg5Ryby5Av5hmS1CXIJaCIaQh3QsrZeLb5vtCtCE8xyyKms6+593NadKPypMOkyKRwFCVPBlAkVKK/Ce5QKMM6GgZp0CQQOzobCrSsnLrl+n+c+jhTy57yidSWmkuretqO1u2PnnuMeEOM8vqahM/fCnEu/bG1AKug3aYzSXhiWxN13fumaIvoZW9BtwgYQaiDj+88s/eayEEg7LxEkgjQz+p9XapakiKFjKwfoZp2EtgDyHyYlPMsQeLF9AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="hcplog"\n        title=""\n        src="/static/ea8676ed7d7a1a6b7ce3db301e555d8e/b86bf/hcplog.png"\n        srcset="/static/ea8676ed7d7a1a6b7ce3db301e555d8e/5243c/hcplog.png 240w,\n/static/ea8676ed7d7a1a6b7ce3db301e555d8e/b86bf/hcplog.png 368w"\n        sizes="(max-width: 368px) 100vw, 368px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}}),"\n문제 상황이 발생하면, (active=5, idle=0, waiting=0) 상태가 됩니다.\n이후 보내는 모든 요청은 waiting에서 기다리다가 timeout 됩니다."),"\n",a.createElement(n.h4,null,"Connection Pool을 10개까지 늘려보자"),"\n",a.createElement(n.p,null,"connection pool을 10개로 늘려도, 문제 상황이 발생하면 (active=5, idle=5, waiting=0) 상태가 됩니다.\n이후 요청을 보낼 때마다 처리가 가능하면 idle 상태의 connection은 active 상태가 됐다가 다시 idle 상태로 돌아오고, 처리가 불가능하다면 active 상태에 머무릅니다."),"\n",a.createElement(n.blockquote,null,"\n",a.createElement(n.p,null,a.createElement(n.strong,null,"즉, Hikari Connection Pool Deadlock 현상이 아닙니다."),a.createElement("br"),"\nDeadlock 이었다면, Pool 개수를 늘렸을 때 문제가 해결되어야 합니다."),"\n"),"\n",a.createElement("br"),"\n",a.createElement(n.h3,null,"가설2: Connection Leak"),"\n",a.createElement(n.p,null,"이후 connection leak 로그를 찍어보고 디버깅을 시작했습니다.\nconnection을 반환하는 곳에 breakpoint를 걸어두고 디버깅을 해본 결과 connection을 잘 가져오고 있었습니다."),"\n",a.createElement(n.p,null,"그러나 애초에 connection leak은 말을 손바닥 뒤집듯 바꾸는 진중하지 못한 친구입니다.\n설정 파일에서 설정한 시간 안에 connection을 가져오지 못할 때 connection leak 로그가 남게 되는데,\n늦게라도 connection을 가져오면 “엥 잘되네? 미안미안~ 아니었나부다” 라는 로그를 다시 남깁니다."),"\n",a.createElement(n.h4,null,"Connection Leak 로그를 맞닥뜨린 후 문제 없는 다른 api를 호출하자"),"\n",a.createElement(n.p,null,"같은 database에 접근하는 다른 api를 호출했을 때 결과가 잘 왔습니다."),"\n",a.createElement(n.blockquote,null,"\n",a.createElement(n.p,null,a.createElement(n.strong,null,"즉, Connection Leak 현상이 아닙니다."),a.createElement("br"),"\nconnection leak 현상이었다면 다른 api를 호출했을 때도 똑같이 connection leak이 발생했어야 합니다."),"\n"),"\n",a.createElement("br"),"\n",a.createElement(n.h3,null,"가설3: Database Layer"),"\n",a.createElement(n.p,null,"그렇다면 database와 통신하는 과정에서 문제가 있는 것은 아닐까?"),"\n",a.createElement(n.h4,null,"너, 지금 과하게 조인하고 있어"),"\n",a.createElement(n.p,null,"과하게 join하고 있다는 의견을 듣고 과한 join이 일어나는 쿼리를 제외하고 실행도 해보고, 소소한 성능 개선도 했습니다.\n이 문제도 아니었습니다."),"\n",a.createElement(n.h4,null,"DB에 접속하긴 하나?"),"\n",a.createElement(n.p,null,"의문이 들고난 이후로 connection 이후로 db에 쿼리를 날리는 그 사이를 디버깅했습니다.\n결과적으로 한 메서드에서 3개의 쿼리를 날린다고 했을 때, 하나는 쿼리를 날리고 두 개는 쿼리를 날리지 않고 있었습니다."),"\n",a.createElement(n.p,null,a.createElement(n.strong,null,"connection은 잘 잡아오지만 쿼리를 날리지 않는다.")),"\n",a.createElement("br"),"\n",a.createElement(n.h2,null,"문제 해결"),"\n",a.createElement(n.h3,null,"삽질하면서 알아낸 내용"),"\n",a.createElement(n.ul,null,"\n",a.createElement(n.li,null,"무한펜딩 api는 공통적으로 2개의 도메인과 관련이 있다."),"\n",a.createElement(n.li,null,"무한펜딩 api 발생 후 위 두 개의 도메인이 아닌 다른 도메인과 관련된 api에 요청을 하면 응답이 잘 온다."),"\n",a.createElement(n.li,null,"이전에 한 번이라도 두 개의 도메인에 접근했다면 무한펜딩 현상이 발생하지 않는다."),"\n"),"\n",a.createElement(n.h3,null,"static class는 multi-thread 환경에 영향을 받지 않나?"),"\n",a.createElement(n.p,null,"라는 생각이 들어 관련 키워드로 검색했고 결국 3일 만에 해결했습니다.\n",a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 853px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 30.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2klEQVR42k2P246EIBBE/f9P1BF01sREkKvKeAG2GmaTrQdoSFef6mbbtnEYGOvbruOctW3b92yapvf7ZxyH16vrGeOcz/Occ04p5X9qQghCSKWUFGJdpViEKhKSPpdlkVRoaN9379wRwhPj13xdpzHGOmetU5q6nHdaK1vkvddGGWu10VJiuEQHOpH3eR6YLxCK3ZXCwL9CBUdzrTmOkHKKMSI2LpBr3eDavEczONVWPXUQnRRZUwTkUQpr3vcN5HmezecTZDHABnghE00T0+LpaCNbaV/4n34Be2FTdlayGnwAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="qinit"\n        title=""\n        src="/static/d4e8cd55c61bc0d46a6ce18345e9cf89/6fbab/qinit.png"\n        srcset="/static/d4e8cd55c61bc0d46a6ce18345e9cf89/5243c/qinit.png 240w,\n/static/d4e8cd55c61bc0d46a6ce18345e9cf89/ab158/qinit.png 480w,\n/static/d4e8cd55c61bc0d46a6ce18345e9cf89/6fbab/qinit.png 853w"\n        sizes="(max-width: 853px) 100vw, 853px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}})),"\n",a.createElement(n.p,null,"A 도메인이 B 도메인을 참조하고, B 도메인이 A 도메인을 참조하는데\n멀티 쓰레드 환경에서 5개의 api를 따발총처럼 부르니 querydsl에서 deadlock이 발생해 생긴 문제였습니다.\n다음과 같이 단일 thread에서 클래스를 초기화해서 해결했습니다.\n",a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 685px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 38.75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA90lEQVR42n2Ri27DIAxF+zUNr5gUMJhHCVmqTf3/HxpZ03WZtElHyLJ0L9f2yYUCJiiNAnCQjqkDg/rd+cnp49Y672tbl4o+8hE74gE8X8BHn49Hsb1UM83OlZQTUep6c6loGiKlmH2I6AlDDCFaJAH+IAZNk4tss7RM2kGZQdqzdOettuz/2JHmuSwpzi5UoQkg6W5n/GSC1L7b/UkXj5AC1pqXUlffLeiO5R7ruswFqUrXlH8bsSlbe6Fwkdhk77jKu5hv+3ACrPVXTBUoXvJVhzx5MjGbVEabOQSu6Yu9EBC2n/s+v6/yPIxlr2ntzh71lZkp9wm/NVzngTf83wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="singlethreadinit"\n        title=""\n        src="/static/1fae59e4522d28bdfa303ae716ced8f4/deb37/singlethreadinit.png"\n        srcset="/static/1fae59e4522d28bdfa303ae716ced8f4/5243c/singlethreadinit.png 240w,\n/static/1fae59e4522d28bdfa303ae716ced8f4/ab158/singlethreadinit.png 480w,\n/static/1fae59e4522d28bdfa303ae716ced8f4/deb37/singlethreadinit.png 685w"\n        sizes="(max-width: 685px) 100vw, 685px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}})),"\n",a.createElement(n.h4,null,"확인해보기"),"\n",a.createElement(n.p,null,"'Get Thread Dump'라는 옵션을 누르면 그 시점에 Thread 상태를 dump 떠줍니다.\n",a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 854px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 26.25%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8klEQVR42k2Oy2rDMBRE/TGJY+thPSxdvWzLkuO4JqVQkkI2/YtuSvrxFXRTGA5nM8NU2p9Dfgvr3S8fLt+l2yQkARkgcT1zSExHDVmaIvO/xMKqxgIzQ7ilcuh0Kt4JQ4WFDlCnMIcG95z0LebHlh1b/pca8UPDqgMWNe4xsyHu4JfezHZcwWduYqEd1t7EhuoaScq0UI4JwJ2SyiGqKkShIYoIF+bdhFKOftrKirJJueTGtZByeyKqDzuMr3q8MrMJfyUqVVQNLdXldogvxi9CT2Y4S5i0z2Wik74h+oQk4iHfvi6Pn8vjGW/f4f0p5s9fr9NBT/FakYQAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="getthreaddump"\n        title=""\n        src="/static/34466af63bba54e7a522f2b3d44488b8/76b06/getthreaddump.png"\n        srcset="/static/34466af63bba54e7a522f2b3d44488b8/5243c/getthreaddump.png 240w,\n/static/34466af63bba54e7a522f2b3d44488b8/ab158/getthreaddump.png 480w,\n/static/34466af63bba54e7a522f2b3d44488b8/76b06/getthreaddump.png 854w"\n        sizes="(max-width: 854px) 100vw, 854px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}}),"\n로그를 들여다 보면 thread가 아직 Runnable한 상태이고, QClass를 초기화하고 나서 아무것도 못하고 가만히 있는다는 사실을 확인할 수 있습니다.\n",a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 8.75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdElEQVR42i3L3QrCMAxA4b2JOPzPsG2StalJNx3CpjeKeOn7P4cThI9zdyodP0d7Q36BPECeTbq3XozUUFPIEnL0gi6RS8FJxAF92TW8BZpVe3CLev23XNWbg59nVEUtpD1Zx9b9qmcuQ7wa95ku1t5OPH0B+kgY6F/LZjgAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="threadlog"\n        title=""\n        src="/static/6b2716600fbc99324173f13c68fddd1e/7d769/threadlog.png"\n        srcset="/static/6b2716600fbc99324173f13c68fddd1e/5243c/threadlog.png 240w,\n/static/6b2716600fbc99324173f13c68fddd1e/ab158/threadlog.png 480w,\n/static/6b2716600fbc99324173f13c68fddd1e/7d769/threadlog.png 960w,\n/static/6b2716600fbc99324173f13c68fddd1e/87339/threadlog.png 1440w,\n/static/6b2716600fbc99324173f13c68fddd1e/88b03/threadlog.png 1920w,\n/static/6b2716600fbc99324173f13c68fddd1e/c1219/threadlog.png 2169w"\n        sizes="(max-width: 960px) 100vw, 960px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}})))}var c=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?a.createElement(n,e,a.createElement(l,e)):l(e)},r=t(4765);function s(e){return a.createElement(r.Z,e,a.createElement(c,e))}r.Z}}]);
//# sourceMappingURL=component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-content-file-path-content-posts-querydsl-deadlock-index-mdx-b2aa80e3c925853786e3.js.map